<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WhatsApp Business API Setup</title>
    <script async defer crossorigin="anonymous" src="https://connect.facebook.net/en_US/sdk.js"></script>
</head>
<body>
    <h2>WhatsApp API - Embedded Signup & Message Sending</h2>
    <button onclick="startEmbeddedSignup()">Start WhatsApp Signup</button>
    <p id="status">Status: Waiting...</p>

    <script>
        // âœ… Step 1: Load Facebook SDK & Initialize
        window.fbAsyncInit = function() {
            FB.init({
                appId: '860607322598076',  // ðŸ”¹ Replace with your Facebook App ID
                version: 'v18.0',
                xfbml: true
            });
        };

        // âœ… Step 2: Start WhatsApp Embedded Signup
        function startEmbeddedSignup() {
            FB.login(function(response) {
                if (response.authResponse) {
                    console.log("Signup Successful:", response);
                    document.getElementById("status").innerText = "Signup Successful. Getting Access Token...";
                    exchangeAuthCode(response.authResponse.code);
                } else {
                    document.getElementById("status").innerText = "Signup Failed.";
                }
            }, { scope: 'business_management,whatsapp_business_management,whatsapp_business_messaging' });
        }

        // âœ… Step 3: Exchange Authorization Code for Access Token
        async function exchangeAuthCode(authCode) {
            const url = `https://graph.facebook.com/v18.0/oauth/access_token?client_id=YOUR_APP_ID&client_secret=YOUR_APP_SECRET&redirect_uri=YOUR_REDIRECT_URI&code=${authCode}`;

            try {
                let response = await fetch(url, { method: "POST" });
                let data = await response.json();

                if (data.access_token) {
                    console.log("Access Token Received:", data.access_token);
                    document.getElementById("status").innerText = "Access Token Acquired. Verifying WhatsApp Number...";
                    verifyPhoneNumber(data.access_token);
                } else {
                    console.error("Error Getting Access Token:", data);
                    document.getElementById("status").innerText = "Error Getting Access Token.";
                }
            } catch (error) {
                console.error("Error:", error);
            }
        }

        // âœ… Step 4: Verify WhatsApp Phone Number
        async function verifyPhoneNumber(accessToken) {
            const PHONE_NUMBER_ID = "569845666215174";  // ðŸ”¹ Replace with the client's WhatsApp Business number ID
            const OTP_CODE = "YOUR_OTP_CODE";  // ðŸ”¹ Replace with the 6-digit code received via SMS

            const url = `https://graph.facebook.com/v18.0/${PHONE_NUMBER_ID}/account/verify`;
            const payload = { code: OTP_CODE };

            try {
                let response = await fetch(url, {
                    method: "POST",
                    headers: {
                        "Authorization": `Bearer ${accessToken}`,
                        "Content-Type": "application/json"
                    },
                    body: JSON.stringify(payload)
                });

                let data = await response.json();
                if (data.success) {
                    console.log("Phone Verified:", data);
                    document.getElementById("status").innerText = "Phone Verified. Ready to Send Messages!";
                    sendWhatsAppMessage(accessToken);
                } else {
                    console.error("Verification Failed:", data);
                    document.getElementById("status").innerText = "Phone Verification Failed.";
                }
            } catch (error) {
                console.error("Error:", error);
            }
        }

        // âœ… Step 5: Send a WhatsApp Message
        async function sendWhatsAppMessage(accessToken) {
            const PHONE_NUMBER_ID = "475668095641083";  // ðŸ”¹ Client's WhatsApp Business Number ID
            const RECIPIENT_NUMBER = "+19027814062";  // ðŸ”¹ Replace with test phone number

            const url = `https://graph.facebook.com/v18.0/${PHONE_NUMBER_ID}/messages`;
            const payload = {
                messaging_product: "whatsapp",
                to: RECIPIENT_NUMBER,
                type: "text",
                text: { body: "Hello! This is a test message from the WhatsApp Business API." }
            };

            try {
                let response = await fetch(url, {
                    method: "POST",
                    headers: {
                        "Authorization": `Bearer ${accessToken}`,
                        "Content-Type": "application/json"
                    },
                    body: JSON.stringify(payload)
                });

                let data = await response.json();
                if (data.messages) {
                    console.log("Message Sent:", data);
                    document.getElementById("status").innerText = "Test Message Sent Successfully!";
                } else {
                    console.error("Message Sending Failed:", data);
                    document.getElementById("status").innerText = "Message Sending Failed.";
                }
            } catch (error) {
                console.error("Error:", error);
            }
        }
    </script>
</body>
</html>
